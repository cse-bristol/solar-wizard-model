import math

from shapely import wkt

from solar_model.solar_pv.panels.panels import _roof_panels
from solar_model.test_utils.test_funcs import ParameterisedTestCase

_failed = {"roof_plane_id": 4564,
           "roof": 'MULTIPOLYGON(((402174.6689291877 201156.51700193272,402174.94804027333 201157.43181243743,402174.66892918776 201157.51700193272,402174.86288611405 201158.15270021337,402173.6689291877 201158.51700193275,402173.9480438233 201159.43180808862,402173.6689291877 201159.51700193275,402173.960761673 201160.4734713784,402174.9172311187 201160.18163889306,402174.7232682645 201159.5459283156,402175.8755922246 201159.19433782136,402175.96076167305 201159.47347137838,402176.8637731784 201159.19794220856,402176.0537273303 201156.75329463044,402177.0074326843 201156.43747681152,402176.9981326967 201156.41656516813,402176.7105435013 201156.50431273817,402176.63172962464 201156.2459252929,402176.03939897625 201156.50935515473,402175.9981344677 201156.41655202807,402175.7105888302 201156.50428416577,402175.6317365581 201156.24593484204,402175.03939897625 201156.50935515473,402174.99813033856 201156.4165579609,402174.6689291877 201156.51700193272)),((402177.4319188277 201156.2969089858,402182.1684376417 201154.72841926842,402182.0609283978 201154.39738829125,402181.7105963785 201154.50427959274,402181.6317350394 201154.2459276868,402181.03939897625 201154.50935515473,402180.9981302456 201154.4165579893,402180.6689291877 201154.51700193272,402180.8628853744 201155.15269509784,402179.71057818667 201155.5042804746,402179.63173383044 201155.2459282244,402179.0393989762 201155.50935515473,402178.9981307187 201155.416553715,402178.71057979076 201155.50428771586,402178.63173505117 201155.24593237217,402177.74696412834 201155.6394133341,402177.953114895 201156.10300158983,402177.8603038773 201156.14427709693,402177.86287929624 201156.15271863286,402177.79421122815 201156.17367024094,402177.7654533616 201156.18645962258,402177.4319188277 201156.2969089858)),((402183.64391982864 201153.2858719331,402183.6317325998 201153.24592877182,402183.2174463848 201153.43017277692,402183.64391982864 201153.2858719331)),((402182.9981260512 201153.4165592691,402182.66892918776 201153.51700193275,402182.6962441961 201153.60652588095,402183.1093326561 201153.466753958,402183.03207748197 201153.49289388995,402182.9981260512 201153.4165592691)),((402183.1093326561 201153.466753958,402183.2174463848 201153.43017277692,402183.2174463846 201153.43017277698,402183.1093326561 201153.466753958)))',
           "aspect": 16.96769614100002,
           "slope": 25.924800796490043,
           "is_flat": False}

_no_panels = {"roof_plane_id": 2620,
              "roof": "Polygon ((402034.20776647521415725 202521.03231001805397682, 402033.70807106170104817 202520.51486026970087551, 402034.20776647509774193 202520.03231001817039214, 402034.19062131328973919 202520.01455568341771141, 402035.07987398374825716 202519.15581436161301099, 402032.27570524608017877 202516.29223845576052554, 402030.64963580697076395 202517.85775490032392554, 402033.9720082322601229 202521.25997910683508962, 402034.20776647521415725 202521.03231001805397682))",
              "aspect": 224,
              "slope": 10,
              "is_flat": True}

_failed_2 = {"roof_plane_id": 594480,
             "roof": "POLYGON((250372.45184260394 667686.086157179,250375.583231356 667682.9954358133,250375.44143863613 667682.8536430935,250375.59144052747 667682.7036412022,250372.89538316173 667679.9854850055,250372.7343318549 667680.1465363123,250372.734331855 667680.1465363123,250372.7343318549 667680.1465363124,250372.94143863604 667680.3536430935,250372.08788524545 667681.2071964841,250371.73433185488 667681.5607498747,250372.61301151133 667682.4394295311,250372.32011829258 667682.7323227499,250371.44143863607 667681.8536430935,250370.73433185494 667682.5607498747,250370.73433185497 667682.5607498747,250369.8303835773 667683.4646981524,250372.45184260394 667686.086157179))",
              "aspect": 45,
              "slope": 30.40771319001589,
              "is_flat": False}

_failed_3 = {"roof_plane_id": 355412,
             "roof": "POLYGON((250372.45184260394 667686.086157179,250375.583231356 667682.9954358133,250375.44143863613 667682.8536430935,250375.59144052747 667682.7036412022,250372.89538316173 667679.9854850055,250372.7343318549 667680.1465363123,250372.734331855 667680.1465363123,250372.7343318549 667680.1465363124,250372.94143863604 667680.3536430935,250372.08788524545 667681.2071964841,250371.73433185488 667681.5607498747,250372.61301151133 667682.4394295311,250372.32011829258 667682.7323227499,250371.44143863607 667681.8536430935,250370.73433185494 667682.5607498747,250370.73433185497 667682.5607498747,250369.8303835773 667683.4646981524,250372.45184260394 667686.086157179))",
              "aspect": 45,
              "slope": 33.38218867087478,
              "is_flat": False}

_failed_4 = {
    "roof_plane_id": 379,
    "roof": "Polygon ((359543.20120662119006738 171673.41487791753024794, 359540.64473488763906062 171671.7105634284671396, 359538.51185952342348173 171674.64621451843413524, 359541.08342345798155293 171676.32975637484923936, 359543.20120662119006738 171673.41487791753024794))",
    "aspect": 234,
    "slope": 31.3,
    "is_flat": False
}

_failed_5 = {"roof_plane_id": 122854,
             "roof": "POLYGON((249760.12704437372 626607.1358319436,249759.4682922151 626607.7826067902,249761.9377751451 626610.2520897201,249761.883414631 626610.3064157633,249762.07293339528 626610.4959345276,249761.28004017647 626611.2888277464,249761.0902699396 626611.0990575096,249760.38293889363 626611.805940026,249760.78004017647 626612.2030413088,249761.19425373722 626611.788827748,249761.78004017644 626611.7888277464,249761.78004017647 626611.7888277464,249761.07293339528 626612.4959345277,249762.78004017647 626614.2030413089,249763.19425373717 626613.7888277483,249763.78004017647 626613.7888277466,249763.07293339528 626614.4959345278,249763.41325344006 626614.8362545726,249764.96808969165 626613.2824042666,249767.10144675628 626615.4157613313,249767.25499366134 626615.2637812315,249766.48714695772 626614.4959345278,249766.78004017664 626614.2030413089,249767.5320395293 626614.9550406616,249767.49786653311 626615.0233866542,249769.76781417412 626612.7766017442,249768.98714695772 626611.9959345278,249769.48714695772 626611.4959345278,249768.78004017647 626610.7888277465,249768.28004017653 626611.2888277466,249767.6335935671 626610.642381137,249766.63359356712 626609.6423811371,249765.78004017653 626608.7888277465,249765.28004017653 626609.2888277465,249764.63359356706 626608.6423811371,249763.9871469577 626607.9959345277,249764.48714695778 626607.4959345277,249763.78004017656 626606.7888277465,249763.36582662328 626607.2030412997,249762.78004017659 626607.2030413088,249763.48714695772 626606.4959345276,249762.14539299754 626605.1541805675,249761.43179899818 626605.8548001305,249761.57293339533 626605.9959345276,249761.28004017653 626606.2888277464,249760.28004017659 626607.2888277464,249760.12704437372 626607.1358319436),(249761.7800401765 626611.7888277464,249762.3658266157 626611.788827748,249762.78004017647 626612.2030413088,249763.25365106907 626611.7294304161,249763.60512293162 626611.9637449916,249762.72330296904 626612.8455649541,249762.60982855398 626612.618616124,249761.78004017647 626611.7888277464,249761.7800401765 626611.7888277464),(249766.40803921348 626612.2030413027,249765.8658266186 626612.2030412994,249766.1764867946 626611.7888277341,249766.6151459975 626611.7888277224,249766.40803921348 626612.2030413027))",
             "slope": 29.26447263529352,
             "aspect": 315,
             "is_flat": False}


def panel_count(roof):
    panels = _roof_panels(
        roof=wkt.loads(roof['roof']),
        panel_w=0.99,
        panel_h=1.64,
        aspect=roof['aspect'],
        slope=roof['slope'],
        panel_spacing_m=0.01,
        is_flat=roof['is_flat'])
    return len(panels) if panels else 0


class PanelTest(ParameterisedTestCase):

    def test_specific_failures(self):
        self.parameterised_test([
            # This failure was caused by the roof plane being a very jagged multipolygon
            # that became invalid once rotated. (it was a multi because the negative
            # buffering from the edge of the building had split it into parts). Fixed by
            # making the algorithm only use the largest sub-polygon of a multi.
            (_failed, 1),
            (_failed_2, 7),
            (_failed_3, 7),
            # (_failed_5, 6),  # TODO known GEOS bug; needs shapely upgrading to 2.0.0
        ], panel_count)

    def test_panel_packing(self):
        self.parameterised_test([
            # This roof can fit 6, but algorithm was only placing 3:
            (_failed_4, 6),
        ], panel_count)

    def test_small_flat_roof(self):
        self.assertEqual(panel_count(_no_panels), 1)

    def test_panel_area_footprint(self):
        w = 0.99
        h = 1.64
        slope = _failed['slope']
        panels = _roof_panels(
            roof=wkt.loads(_failed['roof']),
            panel_w=w,
            panel_h=h,
            aspect=_failed['aspect'],
            slope=slope,
            panel_spacing_m=0.01,
            is_flat=_failed['is_flat'])
        footprint = w * h * math.cos(math.radians(slope))
        assert abs(panels[0].area - footprint) < 0.00001, f"Had {panels[0].area}, wanted {footprint}"
